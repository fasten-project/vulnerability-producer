/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package eu.fasten.vulnerabilityproducer.utils.mappers;

import eu.fasten.vulnerabilityproducer.utils.Vulnerability;

import java.util.ArrayList;
import java.util.List;

/**
 * This class is a helper to map YAML vulnerability information to classes.
 * There are two different formats used for Maven packages and Pypi packages.
 * Find more information here:
 * Maven: https://github.com/fabric8-analytics/cvedb/blob/master/database/java/2012/3536.yaml
 * Pypi: https://github.com/fabric8-analytics/cvedb/blob/master/database/python/2013/1443.yaml
 */
public class YAMLHandler {
    public static class JavaVulnMapper {
        public String cve;
        public String title;
        public String description;
        public Double cvss_v2;
        public Double cvss_v3;
        public List<String> references;
        public List<JavaPgkMapper> affected;
        public List<String> package_urls;

        public JavaVulnMapper() {
        }

        public String getCve() {
            return cve;
        }

        public void setCve(String cve) {
            this.cve = cve;
        }

        public String getTitle() {
            return title;
        }

        public void setTitle(String title) {
            this.title = title;
        }

        public String getDescription() {
            return description;
        }

        public void setDescription(String description) {
            this.description = description;
        }

        public Double getCvss_v2() {
            return cvss_v2;
        }

        public void setCvss_v2(Double cvss_v2) {
            this.cvss_v2 = cvss_v2;
        }

        public Double getCvss_v3() {
            return cvss_v3;
        }

        public void setCvss_v3(Double cvss_v3) {
            this.cvss_v3 = cvss_v3;
        }

        public List<String> getReferences() {
            return references;
        }

        public void setReferences(List<String> references) {
            this.references = references;
        }

        public List<JavaPgkMapper> getAffected() {
            return affected;
        }

        public void setAffected(List<JavaPgkMapper> affected) {
            this.affected = affected;
        }

        public List<String> getPackage_urls() {
            return package_urls;
        }

        public void setPackage_urls(List<String> package_urls) {
            this.package_urls = package_urls;
        }
    }

    public static class JavaPgkMapper {
        public String groupId;
        public String artifactId;
        public List<String> version;
        public List<String> fixedin;
        public List<String> unaffected;

        public JavaPgkMapper() {
        }

        public String getGroupId() {
            return groupId;
        }

        public void setGroupId(String groupId) {
            this.groupId = groupId;
        }

        public String getArtifactId() {
            return artifactId;
        }

        public void setArtifactId(String artifactId) {
            this.artifactId = artifactId;
        }

        public List<String> getVersion() {
            return version;
        }

        public void setVersion(List<String> version) {
            this.version = version;
        }

        public List<String> getFixedin() {
            return fixedin;
        }

        public void setFixedin(List<String> fixedin) {
            this.fixedin = fixedin;
        }

        public List<String> getUnaffected() {
            return unaffected;
        }

        public void setUnaffected(List<String> unaffected) {
            this.unaffected = unaffected;
        }
    }

    /**
     * Creates a Vulnerability object from YAML mapping and vulnerable Purls
     *
     * @param javaPgk         - Java Package Mapper
     * @param vulnerablePURLs - set of vulnerable PURLs
     * @return Vulnerability Object
     */
    public static Vulnerability buildJavaVulnerabilityFromYaml(YAMLHandler.JavaVulnMapper javaPgk, List<String> vulnerablePURLs) {
        Vulnerability v = new Vulnerability("CVE-" + javaPgk.getCve());
        if (javaPgk.description != null) {
            v.setDescription(javaPgk.title + "\n" + javaPgk.description);
        } else {
            v.setDescription(javaPgk.title);
        }
        v.setScoreCVSS2(javaPgk.cvss_v2);
        v.setScoreCVSS3(javaPgk.cvss_v3);
        if (javaPgk.references != null) {
            for (String ref : javaPgk.references) {
                v.addReference(ref);
            }
        }
        if (vulnerablePURLs.size() > 0) {
            for (String purl : vulnerablePURLs) {
                v.addPurl(purl);
            }
        }
        return v;
    }

    public static class PythonVulnMapper {
        public String cve;
        public String title;
        public String description;
        public String cvss_v2;
        public String cvss_v3;
        public List<String> references;
        public List<PythonPgkMapper> affected;
        public List<String> package_urls;

        public PythonVulnMapper() {
        }

        public String getCve() {
            return cve;
        }

        public void setCve(String cve) {
            this.cve = cve;
        }

        public String getTitle() {
            return title;
        }

        public void setTitle(String title) {
            this.title = title;
        }

        public String getDescription() {
            return description;
        }

        public void setDescription(String description) {
            this.description = description;
        }

        public String getCvss_v2() {
            return cvss_v2;
        }

        public void setCvss_v2(String cvss_v2) {
            this.cvss_v2 = cvss_v2;
        }

        public String getCvss_v3() {
            return cvss_v3;
        }

        public void setCvss_v3(String cvss_v3) {
            this.cvss_v3 = cvss_v3;
        }

        public List<String> getReferences() {
            return references;
        }

        public void setReferences(List<String> references) {
            this.references = references;
        }

        public List<PythonPgkMapper> getAffected() {
            return affected;
        }

        public void setAffected(List<PythonPgkMapper> affected) {
            this.affected = affected;
        }

        public List<String> getPackage_urls() {
            return package_urls;
        }

        public void setPackage_urls(List<String> package_urls) {
            this.package_urls = package_urls;
        }
    }

    public static class PythonPgkMapper {
        public String name;
        public List<String> version;
        public List<String> fixedin;
        public List<String> fixed;
        public List<String> unaffected;

        public PythonPgkMapper() {
        }

        public String getName() {
            return name;
        }

        public void setName(String name) {
            this.name = name;
        }

        public List<String> getVersion() {
            return version;
        }

        public void setVersion(List<String> version) {
            this.version = version;
        }

        public List<String> getFixedin() {
            return fixedin;
        }

        public void setFixedin(List<String> fixedin) {
            this.fixedin = fixedin;
        }

        public List<String> getFixed() {
            return fixed;
        }

        public void setFixed(List<String> fixed) {
            this.fixed = fixed;
        }

        public List<String> getUnaffected() {
            return unaffected;
        }

        public void setUnaffected(List<String> unaffected) {
            this.unaffected = unaffected;
        }
    }

    public static class VulnerabilityStatement {
        public String vulnerability_id;
        public List<String> aliases;
        public List<Fixer> fixes;
        public List<String> artifacts;
        public List<NoteMapper> notes;

        public VulnerabilityStatement() {
        }

        public String getVulnerability_id() {
            return vulnerability_id;
        }

        public void setVulnerability_id(String vulnerability_id) {
            this.vulnerability_id = vulnerability_id;
        }

        public List<String> getAliases() {
            return aliases;
        }

        public void setAliases(List<String> aliases) {
            this.aliases = aliases;
        }

        public List<Fixer> getFixes() {
            return fixes;
        }

        public void setFixes(List<Fixer> fixes) {
            this.fixes = fixes;
        }

        public List<String> getArtifacts() {
            return artifacts;
        }

        public void setArtifacts(List<String> artifacts) {
            this.artifacts = artifacts;
        }

        public List<NoteMapper> getNotes() {
            return notes;
        }

        public void setNotes(List<NoteMapper> notes) {
            this.notes = notes;
        }
    }

    public static class Fixer {
        public String id;
        public List<CommitMapper> commits;

        public Fixer() {
        }

        public String getId() {
            return id;
        }

        public void setId(String id) {
            this.id = id;
        }

        public List<CommitMapper> getCommits() {
            return commits;
        }

        public void setCommits(List<CommitMapper> commits) {
            this.commits = commits;
        }
    }

    public static class CommitMapper {
        public String id;
        public String repository;

        public CommitMapper() {
        }

        public String getId() {
            return id;
        }

        public void setId(String id) {
            this.id = id;
        }

        public String getRepository() {
            return repository;
        }

        public void setRepository(String repository) {
            this.repository = repository;
        }
    }

    public static class NoteMapper {
        public List<String> links;
        public String text;

        public NoteMapper() {
        }

        public List<String> getLinks() {
            return links;
        }

        public void setLinks(List<String> links) {
            this.links = links;
        }

        public String getText() {
            return text;
        }

        public void setText(String text) {
            this.text = text;
        }
    }

    /**
     * Convert from PythonPgkMapper to Vulnerability Object
     *
     * @param pythonPgk       - Python Vulnerable Package to convert
     * @param vulnerablePURLs - Set of vulnerable PURLS
     * @return Vulnerability object
     */
    public static Vulnerability buildPythonVulnerabilityFromYaml(YAMLHandler.PythonVulnMapper pythonPgk, List<String> vulnerablePURLs) {
        Vulnerability v = new Vulnerability("CVE-" + pythonPgk.getCve());
        if (pythonPgk.description != null) {
            v.setDescription(pythonPgk.title + "\n" + pythonPgk.description);
        } else {
            v.setDescription(pythonPgk.title);
        }
        if (pythonPgk.getCvss_v2() != null) {
            v.setScoreCVSS2(Double.valueOf(pythonPgk.cvss_v2));
        }
        if (pythonPgk.getCvss_v3() != null) {
            v.setScoreCVSS3(Double.valueOf(pythonPgk.cvss_v3));
        }
        for (String ref : pythonPgk.references) {
            v.addReference(ref);
        }
        for (String purl : vulnerablePURLs) {
            v.addPurl(purl);
        }
        return v;
    }

    /**
     * This class maps statements reported in project_kb by SAP
     */
    public static class SAPVulnMapper {
        public SAPVulnMapper() {
            this.fixes = new ArrayList<>();
            this.notes = new ArrayList<>();
            this.artifacts = new ArrayList<>();
        }

        public String vulnerability_id;
        public List<NoteMapper> notes;
        public List<FixMapper> fixes;
        public List<ArtifactMapper> artifacts;

        public String getVulnerability_id() {
            return vulnerability_id;
        }

        public void setVulnerability_id(String vulnerability_id) {
            this.vulnerability_id = vulnerability_id;
        }

        public List<NoteMapper> getNotes() {
            return notes;
        }

        public void setNotes(List<NoteMapper> notes) {
            this.notes = notes;
        }

        public List<FixMapper> getFixes() {
            return fixes;
        }

        public void setFixes(List<FixMapper> fixes) {
            this.fixes = fixes;
        }

        public List<ArtifactMapper> getArtifacts() {
            return artifacts;
        }

        public void setArtifacts(List<ArtifactMapper> artifacts) {
            this.artifacts = artifacts;
        }

        public Vulnerability translateFromStatement() {
            Vulnerability v = new Vulnerability(this.vulnerability_id);
            v.setDescription(this.notes.get(0).text);
            for (FixMapper fix : this.fixes) {
                for (CommitMapper commit : fix.commits) {
                    if (commit.repository.startsWith("https://github.com")) {
                        v.addPatchLink(commit.repository + "/commit/" + commit.id);
                    }
                    if (commit.repository.matches("http[s]://git.*\\.org.*")) {
                        v.addPatchLink(commit.repository.substring(0, commit.repository.length() - 4) + "/commit/" + commit.id);
                    }
                }
            }
            for (ArtifactMapper artifact : this.artifacts) {
                if (artifact.affected)
                    v.addPurl(artifact.id);
            }
            return v;
        }
    }

    public static class NoteTextMapper {
        public NoteTextMapper() {
        }

        public NoteTextMapper(String text) {
            this.text = text;
        }

        public String text;

        public String getText() {
            return text;
        }

        public void setText(String text) {
            this.text = text;
        }
    }

    public static class FixMapper {
        public FixMapper() {
            this.commits = new ArrayList<>();
        }

        public String id;
        public List<CommitMapper> commits;

        public String getId() {
            return id;
        }

        public void setId(String id) {
            this.id = id;
        }

        public List<CommitMapper> getCommits() {
            return commits;
        }

        public void setCommits(List<CommitMapper> commits) {
            this.commits = commits;
        }
    }

    public static class ArtifactMapper {
        public ArtifactMapper() {
        }

        public String id;
        public String reason;
        public boolean affected;

        public String getId() {
            return id;
        }

        public void setId(String id) {
            this.id = id;
        }

        public String getReason() {
            return reason;
        }

        public void setReason(String reason) {
            this.reason = reason;
        }

        public boolean isAffected() {
            return affected;
        }

        public void setAffected(boolean affected) {
            this.affected = affected;
        }
    }

    public static class RubyAdvisoryMapper {
        public String gem;
        public String framework;
        public String platform;
        public String library;
        public String cve;
        public int osvdb;
        public String ghsa;
        public List<String> unaffected_versions;
        public List<String> patched_versions;
        public List<String> vendor_patch;
        public RubyRelatedMapper related;
        public String url;
        public String title;
        public String date;
        public String description;
        public Double cvss_v2;
        public Double cvss_v3;

        public RubyAdvisoryMapper() {
        }

        public String getGem() {
            return gem;
        }

        public void setGem(String gem) {
            this.gem = gem;
        }

        public String getFramework() {
            return framework;
        }

        public void setFramework(String framework) {
            this.framework = framework;
        }

        public String getPlatform() {
            return platform;
        }

        public void setPlatform(String platform) {
            this.platform = platform;
        }

        public String getLibrary() {
            return library;
        }

        public void setLibrary(String library) {
            this.library = library;
        }

        public String getCve() {
            return cve;
        }

        public void setCve(String cve) {
            this.cve = cve;
        }

        public int getOsvdb() {
            return osvdb;
        }

        public void setOsvdb(int osvdb) {
            this.osvdb = osvdb;
        }

        public String getUrl() {
            return url;
        }

        public void setUrl(String url) {
            this.url = url;
        }

        public String getTitle() {
            return title;
        }

        public void setTitle(String title) {
            this.title = title;
        }

        public String getDate() {
            return date;
        }

        public void setDate(String date) {
            this.date = date;
        }

        public String getDescription() {
            return description;
        }

        public void setDescription(String description) {
            this.description = description;
        }

        public Double getCvss_v2() {
            return cvss_v2;
        }

        public void setCvss_v2(Double cvss_v2) {
            this.cvss_v2 = cvss_v2;
        }

        public Double getCvss_v3() {
            return cvss_v3;
        }

        public void setCvss_v3(Double cvss_v3) {
            this.cvss_v3 = cvss_v3;
        }

        public String getGhsa() {
            return ghsa;
        }

        public void setGhsa(String ghsa) {
            this.ghsa = ghsa;
        }

        public List<String> getUnaffected_versions() {
            return unaffected_versions;
        }

        public void setUnaffected_versions(List<String> unaffected_versions) {
            this.unaffected_versions = unaffected_versions;
        }

        public List<String> getPatched_versions() {
            return patched_versions;
        }

        public void setPatched_versions(List<String> patched_versions) {
            this.patched_versions = patched_versions;
        }

        public List<String> getVendor_patch() {
            return vendor_patch;
        }

        public void setVendor_patch(List<String> vendor_patch) {
            this.vendor_patch = vendor_patch;
        }

        public RubyRelatedMapper getRelated() {
            return related;
        }

        public void setRelated(RubyRelatedMapper related) {
            this.related = related;
        }

        /**
         public String gem;

         public List<String> unaffected_versions;
         public List<String> patched_versions;

         * @return
         */
        public Vulnerability translateFromStatement(VersionRanger vr) {
            var v  = new Vulnerability();
            if (this.cve != null) {
                v.setId("CVE-" + this.cve);
            } else if (this.ghsa != null) {
                v.setId("GHSA-" + this.ghsa);
            } else {
                v.setId("OSVDB-" + this.osvdb);
            }

            v.setDescription(this.title + "\n" + this.description);
            v.setPublishedDate(this.date);
            if (this.cvss_v2 != null)   v.setScoreCVSS2(this.cvss_v2);
            if (this.cvss_v3 != null)   v.setScoreCVSS2(this.cvss_v3);

            v.addReference(this.url);
            if (this.vendor_patch != null) this.vendor_patch.forEach(v::addReference);
            if (this.related != null)
                if (this.related.url != null)  this.related.url.forEach(v::addReference);

            if (this.patched_versions != null) {
                if (this.unaffected_versions != null)
                    this.patched_versions.addAll(this.unaffected_versions);

                var purls = vr.getVulnerablePURLsRuby(this.gem, this.patched_versions);
                v.setPurls(purls);
            }
            return v;
        }
    }

    public static class RubyRelatedMapper {
        List<String> url;
        List<String> cve;
        List<String> ghsa;
        List<String> osvdb;

        public RubyRelatedMapper() {
        }

        public List<String> getUrl() {
            return url;
        }

        public void setUrl(List<String> url) {
            this.url = url;
        }

        public List<String> getCve() {
            return cve;
        }

        public void setCve(List<String> cve) {
            this.cve = cve;
        }

        public List<String> getGhsa() {
            return ghsa;
        }

        public void setGhsa(List<String> ghsa) {
            this.ghsa = ghsa;
        }

        public List<String> getOsvdb() {
            return osvdb;
        }

        public void setOsvdb(List<String> osvdb) {
            this.osvdb = osvdb;
        }
    }
}
